<p align="center" >
  <img src="https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/0fbed41e-1b2b-44f4-9562-6eb7aeeb2c7c" width="256" height="256" alt="NJS"></a>
</p>
<h1 align="center">Semi-Auto-NovelAI-to-Pixiv</h1>
<h4 align="center">‚ú®Generate Images with NovelAI and Upload to Pixiv‚ú®</h4>

<p align="center">
    <img src="https://img.shields.io/badge/Python-3.10+-blue">
    <a href="https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/raw/main/LICENSE"><img src="https://img.shields.io/github/license/zhulinyv/Semi-Auto-NovelAI-to-Pixiv" alt="license"></a>
    <img src="https://img.shields.io/github/issues/zhulinyv/Semi-Auto-NovelAI-to-Pixiv">
    <img src="https://img.shields.io/github/stars/zhulinyv/Semi-Auto-NovelAI-to-Pixiv">
    <img src="https://img.shields.io/github/forks/zhulinyv/Semi-Auto-NovelAI-to-Pixiv">
</p>

## üí¨ Introduction

**Translated by ChatGPT**

‚ú® **Currently implemented functions**:

| Function | Description | Example | Notes |
|:---:|:---:|:---:|:---:|
| Txt2Img | A user interface written for NovelAI using Gradio. Except for the interface, it's identical to using the NovelAI website. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/252b2455-3185-47b4-8606-3a736b3bc99f) | Generated images will be saved to the `./output/t2i` folder. |
| Img2Img | Equivalent to using the NovelAI website. Supports any image. Additionally, batch image generation is supported. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/43d99c78-70ec-42fe-9762-fcacf0b34d4b) | Generated images will be saved to the `./output/i2i` folder. However, a temporary image named `temp.png` will be generated in the `output` folder. You can delete it. When batch processing, please place images in the same folder, for example: `./output/choose_to_i2i`. |
| Random Blue Picture | Generates a random R18 image by randomly combining tags from `./files/favorite.json`, or infinitely generates R18 images. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/faf4e7cb-7a63-4cf1-8056-473d986c004e) | For configuration of random R18 images, refer to the Random R18 Image section in [Other Configurations](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv#%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE). |
| Random Picture | Infinitely generates images by reading `*.txt` in `./file/prompt` files and append prompts which you inputed as prompts. When all `*.txt` files in the folder have been processed once or generation is stopped by clicking, it will stop running. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/7bbfa72b-ab54-4011-9a2e-cebf3a6bd275) | For configuration of random images, refer to the Random Image section in [Other Configurations](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv#%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE). |
| Inpaint | Only supports images generated by NovelAI and requires uploading a mask. Supports batch operations. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/57e91754-c2ec-4bca-9149-cad424569de1) | The uploaded mask should have the redrawn area in white and the rest transparent, with the resolution equal to the redrawn image. When batch processing, please place images and masks in two separate folders with matching filenames, for example: `./output/inpaint/img`, `./output/inpaint/mask`. Generated images will be saved to `./output/inpaint`. |
| Super Resolution | Applies super resolution denoising to images using open-source projects listed in the acknowledgments. Supports processing single images or batches. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/3465c6be-4326-423d-848b-1a281e1e32ae) | Generated images will be saved to the `./output/upscale` folder. It is not recommended to use **srmd-cuda** due to its instability. When using **waifu2x-caffe** or **waifu2x-converter**, a temporary batch file named `temp.bat` will be generated in the `./output` folder, which can be deleted. When batch processing, please place images in the same folder, for example: `./output/choose_to_upscale`. |
| Automatic Mosaic | Automatically detects key parts of images and applies mosaic to them. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/98650568-c58f-4571-8dcd-222e1b48e5be) | Cannot guarantee 100% detection. Generated images will be saved to the `./output/mosaic` folder. When batch processing, please place images in the same folder, for example: `./output/choose_to_mosaic`. |
| Add Watermark | Randomly add a specified number of watermarks with random transparency within a certain position range at the top left, top right, bottom left, or bottom right of the image | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/4016b4f5-6c83-4c8c-b1db-e372eddae425) | Before using, you need to prepare some watermark pictures and put them into `./files/water` folder. When using, please enter the directory of the image to be processed and press confirm, the processed image will be saved to `./output/water` |
| Upload to Pixiv | Batch upload images to Pixiv. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/95603593-6bff-47aa-a5c6-5ba21067e306) | For configuration of Pixiv upload, refer to the Upload to Pixiv section in [Other Configurations](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv#%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE). |
| Image Selection | A tool that manually filters images | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/47a261bc-f962-489f-83b1-2f7381fb5e0a) | To use it, please enter the image directory first and press OK, and then enter the output directory. A file named 'array_data.npy' will be generated in the './output' folder, which will save the progress of the last filter, that is, you can continue to filter without selecting the image directory, and it will be automatically deleted after the filtering |
| Erase Data | Batch erase restore, or export image generation information | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/39383963-838c-4b93-bc1b-14d614343bff) | | When restoring information, it is necessary to prepare at least *.png images with prompts or *.txt files containing prompts, and place them in a certain directory (image information file directory). The filenames (excluding the extension) of the files in the selected directory for restoration must match the filenames in the just mentioned image information file directory |
| Magic Analysis | Reads PNG info using open-source projects listed in the acknowledgments. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/08fcf698-4be3-4ee3-b4a5-4225810740ca) | Embedded into this project using iframe. |
| GPT Free | Free, multi-model GPT using open-source projects listed in the acknowledgments. | ![image](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/a3ae56b2-4fc4-47e1-8d1d-aa01b7114892) | Embedded into this project using iframe. |

Learning Gradio, trying to create a WebUI for this project.

## üíª Configuration Requirements

| Item | Description |
|:---:|:---:|
| NovelAI Membership | To generate images infinitely, it is recommended to have a $25/month membership. |
| Magic Network | To successfully send POST requests, Magic Network is required. |
| 1GB VRAM | At least 1GB of VRAM is required to use all engines for super-resolution denoising. |
| 2GB RAM | At least 2GB of RAM is required for smooth operation of this project. |
| Windows 10/11(x64) | To use all features, a 64-bit version of Windows 10/11 is required. |
| [Microsoft Visual C++ 2015](https://www.microsoft.com/en-us/download/details.aspx?id=53587) | Installation of the runtime library is required to use all engines for super-resolution denoising. |

## üíø Deployment

### 1Ô∏è‚É£ Install Python

Suggested to install [Python 3.10.11](https://www.python.org/ftp/python/3.10.11/python-3.10.11-amd64.exe), During installation, please check **Add Python to PATH** and keep the rest as default.

### 2Ô∏è‚É£ Next step

Now you can launch the `run.bat` at the origin directory to start WebUI, it will create the virtual environment and install the dependences at the first time, it will take a long time, so you can drink some coffe or read the documents below

## ‚öôÔ∏è Configuration

‚ö†Ô∏è 1. Please do not skip this step, as it is crucial to ensure that you have reviewed all configurations.

‚ö†Ô∏è 2. If you have already launched the WebUI but have not completed the necessary configurations, please close it.

‚ö†Ô∏è 3. Before using the project, you need to make a copy of `env.example` and rename it to `.env`.

‚ö†Ô∏è 4. If you have already launched it once, the script will automatically perform the copy and rename operations.

‚ö†Ô∏è 5. Only three configurations are mandatory for the following settings (failure to configure them will render the related features unusable), while the rest can be configured as needed.

| Item | Required | Type | Default | Description | Example |
|:---:|:---:|:---:|:---:|:---:|:---:|
| token |Yes| str | "xxx" | Token required for generating images | "eyJhbG..." |
| img_size |No| int \| list[int] | -1 | Resolution of the generated images | [832, 1216] |
| scale |No| float | 5.0 | Relevance of prompts | 7.0 |
| censor |No| bool | False | Whether to censor the generated images | True |
| sampler |No| str | "k_euler" | Sampler | "k_dpmpp_2m" |
| steps |No| int | 28 | Sampling steps | 20 |
| sm |If sm_dyn is enabled| bool | False | sm | True |
| sm_dyn |No| bool | False | sm_dyn | True |
| noise_schedule |No| str | "native" | Noise schedule | "karras" |
| seed | No | int | -1 | Random seed | 2468751262 |
| magnification | No | float | 1.5 | Magnification for generating images | 1.3 |
| hires_strength | No | float | 0.5 | Redraw strength | 0.6 |
| pixiv_cookie | Yes | str | "xxx" | Cookie for uploading to Pixiv | "first_..." |
| pixiv_token | Yes | str | "xxx" | x-csrf-token for uploading to Pixiv | "655c0c..." |
| allow_tag_edit | No | bool | True | Whether to allow other users to edit tags | False |
| share | No | bool | False | Whether to share the Gradio link | True |
| height | No | int | 650 | Height of the Gradio interface | 800 |
| port | No | int | 11451 | Port for local deployment | 13579 |
| theme | No | str \| None | "NoCrypt/miku" | WebUI interface theme | more theme: [Themes Gallery](https://huggingface.co/spaces/gradio/theme-gallery) |
| caption_prefix | No | str \| None | "Hi there! ËøôÈáåÊòØÂ∞è‰∏´Â§¥ÁâáÂ≠ê, ËäùÂ£´ÊàëÁöÑ QQ Áæ§: 632344043, Ê¨¢Ëøé!" | the prefix of the caption when uploading pictures to pixiv | Hello |
| neighbor | No | float | 0.01 | The square mosaic is relative to the length of the sides of the picture | 0.008 |
| alpha | No | float | 0.7 | Watermark transparency (0~1, the higher the value, the more transparent) | 0.5 |
| water_height | No | int | 135 | Adjust the height of the watermark | 100 |
| position | No | list[str] | ["Â∑¶‰∏ä", "Âè≥‰∏ä", "Â∑¶‰∏ã", "Âè≥‰∏ã"] | Possible positions for the watermark | ["Â∑¶‰∏ä"] |
| water_num | No | int | 1 | Number of watermarks | 2 |
| t2i_cool_time | No | int | 12 | the cool time for t2i (Unit: Seconds (6 seconds up or down)) | 20 |
| webui_lang | No | str | "zh" | Language of the WebUI | "en" |
| pixiv_cool_time | No | int | 15 | The cool time of pixiv uploading (Unit: Minutes (up or minus 5 minutes)) | 240 |
| meta_data | No | str | "ÊùÇÈ±º\~ÊùÇÈ±º\~" | The metadata which you want to add when erasering the metadata | "ÊùÇÈ±º\~ÊùÇÈ±º\~ÊùÇÈ±º\~" |
| g4f_port | No | int | 19198 | The port of G4F webui | 24680 |

‚ö†Ô∏è Getting the token:

- 1. Log in to https://novelai.net/login
- 2. Press F12 to open the console and switch to the console tab.
- 3. Enter `console.log(JSON.parse(localStorage.session).auth_token)` and press Enter. The returned string is the token.
- ![e3756ce75c6f6850efa633dbaa3a5ae6](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/502c9a49-6a73-446d-9401-e559628ad079)

‚ö†Ô∏è Getting pixiv_cookie and pixiv_token:

- 1. Open https://www.pixiv.net/illustration/create and manually upload an image.
- 2. Choose tags, age restrictions, AI-generated work, public range, comments on works, and original works.
- 3. Press F12 to open the console and switch to the Network tab.
- 4. Click on the submit button.
- 5. Find and click on the 'illustraion' request, then switch to the Headers tab.
- 6. In the request headers, you can find the Cookie and X-Csrf-Token.
- ![97ae3696ad11708ae2eb0474f198de0c](https://github.com/zhulinyv/Semi-Auto-NovelAI-to-Pixiv/assets/66541860/e59caaf6-c69d-485e-965d-d7d924397667)

### Other Configurations:

About random pictures, please put the prompt files(e.g.: example.txt, including: prompt) into this directory `./files/prompt`

```
e.g.:
.\files
  ‚îî---\prompt
        ‚îî---ÂèØËéâ.txt -> file contents: tianliang duohe fangdongye, loli, klee_(genshin_impact)
        ‚îî---loli.txt -> file contents: {{{loli}}}
        ‚îî---114514.txt -> file contents: {henghengheng aaaaa}
```

- Regarding Pixiv upload, you need to place the selected images or folders to upload in the same directory, for example `./output/pixiv`.

```
For example:
.\output
  ‚îî---\pixiv
        ‚îî---7589641258_GenshinImpact_ÂèØËéâ.png -> Note: The image name follows the format: seed_source_character.png. Tags will be added based on generation information, source, and character, with the character as the title.
        ‚îî---6594641258dwuibuib_None_None.png  -> Note: The image name follows the format: content_None_None.png. Tags will be added based on generation information, with None as the title.
        ‚îî---ÊãâËè≤.png                          -> Note: Such images may cause errors. Don't worry, if you use images generated entirely by this project, the generated image names will all adhere to the standard format.
        ‚îî---\Nahida                           -> Note: You can treat folders as image groups, meaning one uploaded work contains multiple images.
              ‚îî---5264942125_GenshinImpact_Á∫≥Ë•øÂ¶≤.png
              ‚îî---4351819919_GenshinImpact_Á∫≥Ë•øÂ¶≤.png
```

About random blue pictures, you can add more at the correct position by your self:

```json
{
  "artists": {
    ...,
    "belief": {
      "0.6(probability of extracting art style below, probability here is 1-0.6)": {
        "Art Style(Your preferred art style)": [
          "balabala...",
          0(whether to enable sm, 1 for enable, 0 for disable),
          6.3(relevance of prompts, if set to 0, it will read from the .env file configuration)
        ]
      },
      "0.3(probability of extracting art style below, probability here is 0.6-0.3)": {
        "Art Style(Your preferred art style)": [
          "balabala...",
          0(whether to enable sm, 1 for enable, 0 for disable),
          6.3(relevance of prompts, if set to 0, it will read from the .env file configuration)
        ]
      }
    },
    ...
  },
  "negative_prompt": {
    ...,
    "belief": [
      "prompt(negative prompts)"
    ]
  },
  "character": {
    "Game(Group of characters)": {
      "name(Character name)": [
        "tag1(description of this character)",
        "tag2, tag3(can be single or a series)"
      ]
    }
  },
  "R18": {
    "Action": {
      "Big Breast Action": {
        "name(Action name)": [
          "tag1(description of this action)",
          "tag2, tag3(can be single or a series)"
        ]
      },
      "Ordinary Action": {
        "name(Action name)": [
          "tag1(description of this action)",
          "tag2, tag3(can be single or a series)"
        ]
      }
    },
    "Expression": {
      "Oral Expression": {
        "name(Expression name)": [
          "tag1(description of this expression)",
          "tag2, tag3(can be single or a series)"
        ]
      },
      "Ordinary Expression": {
        "name(Expression name)": [
          "tag1(description of this expression)",
          "tag2, tag3(can be single or a series)"
        ]
      }
    },
    "Scene": {
      "Scene Only": {
        "name(Scene name)": [
          "tag1(description of this scene)",
          "tag2, tag3(can be single or a series)"
        ]
      },
      ...
    },
    ...
  },
  "labels": {
    "Game(Corresponding to the added sources above)": {
      "name(Corresponding to the added characters above)": [
        "char_name(Tags added to this character when uploading to Pixiv)",
        "char_jp_name(Tags added to this character when uploading to Pixiv)"
      ]
    },
    "description": {
      "tag (A certain prompt word)": [
        "tag_label(Tags added to this prompt word when uploading to Pixiv)"
      ]
    }
  }
}
```

## üéâ Use

run `run.bat`, it will start your default browser and jump to [127.0.0.1:11451](http://127.0.0.1:11451)

For old version users: I suggested not to use the independent scripts, please use the WebUI

## üìñ To-Do

+ [x] Batch text-to-image generation
+ [x] Batch image-to-image generation
+ [x] Batch upload to Pixiv
+ [x] Calculate remaining crystals
+ [x] Batch [waifu2x](https://github.com/nagadomi/waifu2x)
+ [x] Batch local redraw
+ [ ] ~~Batch vibe~~
+ [x] Batch mosaic
+ [x] Write a WebUI using Gradio
+ [ ] Containerize the project for persistent running
+ [x] Change the style of the interface
+ [x] ~~Add ChatGPT~~
+ [x] White a picture selector
+ [ ] Get token by account and password
+ [x] Add more upscale engine
+ [x] Add more ways to t2i
+ [x] Batch watermarking
+ [x] Batch PNG info processing
+ [ ] ...

## ü§ù Acknowledgements

This project uses [waifu2x-ncnn-vulkan](https://github.com/nihui/waifu2x-ncnn-vulkan) | [Anime4KCPP](https://github.com/TianZerL/Anime4KCPP) | [realcugan-ncnn-vulkan](https://github.com/nihui/realcugan-ncnn-vulkan/) | [realesrgan-ncnn-vulkan](https://github.com/xinntao/Real-ESRGAN-ncnn-vulkan) | [realsr-ncnn-vulkan](https://github.com/nihui/realsr-ncnn-vulkan/) | [srmd-cuda](https://github.com/MrZihan/Super-resolution-SR-CUDA) | [srmd-ncnn-vulkan](https://github.com/nihui/srmd-ncnn-vulkan) | [waifu2x-caffe](https://github.com/lltcggie/waifu2x-caffe) | [waifu2x-converter](https://github.com/DeadSix27/waifu2x-converter-cpp) for denoising and upscaling images.

This project uses [stable-diffusion-inspector](https://spell.novelai.dev/) for parsing image metadata.

This project uses [Genshin-Sync](https://huggingface.co/spaces/AppleHarem/Genshin-Sync/tree/main) for uploading images to Pixiv.

This project uses [GPT4FREE](https://github.com/xtekky/gpt4free) to provide GPT services.

This project uses  [novelai-image-metadata](https://github.com/NovelAI/novelai-image-metadata) to eraser the metadata.


<hr>
<img width="300px" src="https://count.getloli.com/get/@zhulinyv?theme=rule34"></img>
